<!DOCTYPE html>
<html>
<head>
<style>
.article
{
	width:50%;
	display:inline;
	float:left;
}
.translation
{
	width:50%;
	display:inline;
	float:right;
}
</style>
<!----------------jQuery----------------->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>	
</head>

<body>
	<div class="article">
		<h1>Chinese Population Growth</h1>
		<p>
		I am a student. He is a teacher. I am reading. Pig is fat.
		</p>
		<p>
		University is good. Friends are important.
		</p>
		<p>
		Testing is complicated. He is good.
		</p>
		<p>
		Population grows.</p>
		<p>
		Taiwan is a country. Brad is my brother
		</p>
		<p>
		Exercise is important. Give me more words.
		</p>
	</div>
	<div class="translation">
		
		<p class="show"></p>
	</div>
<script>
var colorRainbow = ["#FFDEDE", "#DEFFDE", "#F1DEFF", "#FFFFDE", "#DEFFFF", "#D6D6FF", "#FFF3DE"];

// when hover the paragraph, show the translation.
$("div.article").find("p").on({
	mouseenter: function(){
		//clean the "show" part is needed before showing the translation result 
		$(".show").html('');
		
		var str = $(this).text(); // text() Sets or returns the text content of selected elements
		// split the paragraph to sentences
		var sentenceArr = splitToSentences(str, 'English');
		
		// get the "top" position of this paragraph (relative to tje window)
		var paragraphTopPos = $(this).offset().top;
		console.log(paragraphTopPos);
		
		// color the original English paragraph
		colorParagraph(sentenceArr, this, paragraphTopPos, function(){
			startTranslate(sentenceArr, paragraphTopPos);
		});
		
		// for DEBUG
		console.log(this.innerHTML);
	},
	mouseleave: function(){
		//$(".show").html('');
		console.log("leave");
		
	}
});
// color the original English paragraph
function colorParagraph(sentenceArr, paragraph, paragraphTopPos, callback){
	setTimeout( function(){
		// first set the background of the article transparent
		$("div.article").find("*").css("background-color", "");
		
		/* then add <span> tag to each sentence */
		if(paragraph.innerHTML.search('</span>')==-1){ // if this is the first visit to the paragraph
			for(var i=0; i<sentenceArr.length; i++){
				var newStr = paragraph.innerHTML.replace(sentenceArr[i], '<span class="os'+i+'">'+sentenceArr[i]+'</span>');
				paragraph.innerHTML = newStr;
				paragraph.children[i].style.background = colorRainbow[i];
			}
		}
		// then color the sentences of the original English paragraph
		for(var i=0; i<sentenceArr.length; i++){
			paragraph.children[i].style.background = colorRainbow[i];
		}
		if(callback){
			callback(sentenceArr);
		}		
	}, 0 );
		
}
function startTranslate(sentenceArr, paragraphTopPos){
	// add space for translated sentences
	addSpaceForTranslatedSentences(sentenceArr);
	// translate each sentence and show in the "show" part
	for(var i=0; i<sentenceArr.length; i++){
		var translateUrl = 'https://script.google.com/macros/s/AKfycbz5GfFa73yU_xI2tM5L1LdriW8zKQoxkEzG81SrnZt_574Q2Ko/exec?source=en&target=zh-tw&q=' + sentenceArr[i];
		translateHoverTexts(translateUrl, i, paragraphTopPos);
	}
}

// add space for translated sentences
function addSpaceForTranslatedSentences(sentenceArr){
	// add <p></p> to wrap the translated senetences
	var node = document.createElement("p");
	document.getElementsByClassName("show")[0].appendChild(node);
	document.getElementsByClassName("show")[0].children[0].className = "translated_paragragh";
	// add corresponding number (number of sentences) of <span> to "show" part and set their class name
	for(var i=0; i<sentenceArr.length; i++){
		var node = document.createElement("span");
		document.getElementsByClassName("translated_paragragh")[0].appendChild(node);
	}
	for(var i=0; i<sentenceArr.length; i++){
		document.getElementsByClassName("translated_paragragh")[0].children[i].className = "s"+i;
	}
}

// outline function for translation
function translateHoverTexts(url, idx, paragraphTopPos){
	httpGetAsync(url, idx, paragraphTopPos, handleTranslation);
}

// http request for the google app script translation
function httpGetAsync(theUrl, idx, paragraphTopPos, callback)
{
	var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
            callback(xmlHttp.responseText, idx, paragraphTopPos);
    }
    xmlHttp.open("GET", theUrl, true); // true for asynchronous 
    xmlHttp.send(null);
}

// after texts are translated, handle the translation result
function handleTranslation(translatedTextJson, idx, paragraphTopPos){

	// parse JSON array
	var rawTranslatedText = JSON.parse(translatedTextJson);
	var parsedTranslatedText = rawTranslatedText.data.translations[0].translatedText;

	// show translation result in the translation div
	showTranslation(parsedTranslatedText, idx, paragraphTopPos);	
} 

// split the paragraph to sentences
function splitToSentences(str, language){
	var sentenceArr = str.split(". ");
	// add '.' back except the last sentence
	for(var i=0; i<sentenceArr.length-1; i++){
		sentenceArr[i] = sentenceArr[i] + '. ';
	}
	console.log(language + ' : ' + sentenceArr.length);
	return sentenceArr;
}

// show translation result in the translation div
function showTranslation(str, idx, paragraphTopPos){
		
    //console.log("span.s"+idx);
	$(".show").find("span.s"+idx).html(str);
	$(".show").find("span.s"+idx).attr('style',  'background-color:'+colorRainbow[idx]);
	$(".translated_paragragh").offset({ top: paragraphTopPos });

}

// highlight the whole paragraph that is hovering
function highlightHoveredTexts(paragraph){
	$("div.article").children().css("backgroundColor", "");
	paragraph.style.backgroundColor = colorRainbow[6];
}

</script>
</body>

</html>